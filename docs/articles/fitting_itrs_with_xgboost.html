<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimation of Flexible ITRs with xgboost â€¢ personalized</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Estimation of Flexible ITRs with xgboost">
<meta property="og:description" content="personalized">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">personalized</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usage_of_the_personalized_package.html">Usage of the personalized Package</a>
    </li>
    <li>
      <a href="../articles/efficiency_augmentation_personalized.html">Utilities for Improving Estimation Efficiency via Augmentation and for Propensity Score Estimation</a>
    </li>
    <li>
      <a href="../articles/multicategory_treatments_with_personalized.html">Multi-category Treatments with personalized</a>
    </li>
    <li>
      <a href="../articles/fitting_itrs_with_xgboost.html">Estimation of Flexible ITRs with xgboost</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jaredhuling/personalized" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Estimation of Flexible ITRs with xgboost</h1>
                        <h4 data-toc-skip class="author">Jared
Huling</h4>
            
            <h4 data-toc-skip class="date">2022-07-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jaredhuling/personalized/blob/HEAD/vignettes/fitting_itrs_with_xgboost.Rmd" class="external-link"><code>vignettes/fitting_itrs_with_xgboost.Rmd</code></a></small>
      <div class="hidden name"><code>fitting_itrs_with_xgboost.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="first-simulate-data-with-complicated-conditional-average-treatment-effectbenefit-score">First simulate data with complicated conditional average treatment
effect/benefit score<a class="anchor" aria-label="anchor" href="#first-simulate-data-with-complicated-conditional-average-treatment-effectbenefit-score"></a>
</h2>
<p>To demonstrate how to estimate flexible individualized treatment
rules using <code>xgboost</code> in the <code>personalized</code>
package, we simulate data with a binary treatment and a complex
relationship between covariates and the effect of the treatment. The
treatment assignments are based on covariates and thus mimic an
observational setting with no unmeasured confounders.</p>
<p>In this simulation, the treatment assignment depends on covariates
and hence we must model the propensity score <span class="math inline">\(\pi(x) = Pr(T = 1 | X = x)\)</span>. In this
simulation we will assume that larger values of the outcome are
better.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jaredhuling.org/personalized/" class="external-link">personalized</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">n.obs</span>  <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="va">n.vars</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n.obs</span> <span class="op">*</span> <span class="va">n.vars</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">n.obs</span>, <span class="va">n.vars</span><span class="op">)</span>

<span class="co"># simulate non-randomized treatment</span>
<span class="va">xbetat</span>   <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>
<span class="va">trt.prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">xbetat</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">xbetat</span><span class="op">)</span><span class="op">)</span>
<span class="va">trt</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n.obs</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">trt.prob</span><span class="op">)</span>

<span class="co"># simulate delta (CATE) as a complex function of the covariates</span>
<span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fl">0.25</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">^</span> <span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0.35</span><span class="op">)</span> <span class="op">+</span> 
                <span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="co"># simulate main effects g(X)</span>
<span class="va">xbeta</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">9</span><span class="op">]</span> <span class="op">^</span> <span class="fl">2</span>
<span class="va">xbeta</span> <span class="op">&lt;-</span> <span class="va">xbeta</span> <span class="op">+</span> <span class="va">delta</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">trt</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.5</span>

<span class="co"># simulate continuous outcomes</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">xbeta</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n.obs</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>To estimate any ITR, we first must construct a propensity score
function. We also optionally (and highly recommended for performance)
can define an augmentation function that estimates main effects of
covariates.</p>
<p>The <code>personalized</code> package has functionality for doing so
using cross-fitting (see the vignette for augmentation):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># arguments can be passed to cv.glmnet via `cv.glmnet.args`.</span>
<span class="co"># normally we would set the number of crossfit folds and internal folds to be larger, </span>
<span class="co"># but have reduced it to make computation time shorter</span>
<span class="va">prop.func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create.propensity.function.html">create.propensity.function</a></span><span class="op">(</span>crossfit <span class="op">=</span> <span class="cn">TRUE</span>,
                                        nfolds.crossfit <span class="op">=</span> <span class="fl">4</span>,
                                        cv.glmnet.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type.measure <span class="op">=</span> <span class="st">"auc"</span>, nfolds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aug.func</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create.augmentation.function.html">create.augmentation.function</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"gaussian"</span>,
                                         crossfit <span class="op">=</span> <span class="cn">TRUE</span>,
                                         nfolds.crossfit <span class="op">=</span> <span class="fl">4</span>,
                                         cv.glmnet.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type.measure <span class="op">=</span> <span class="st">"mse"</span>, nfolds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>For the sake of comparison, first fit a linear ITR. We have set
<code>nfolds</code> to 3 for computational reasons; it should generally
be higher, such as 10.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">subgrp.model.linear</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.subgroup.html">fit.subgroup</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,
                             trt <span class="op">=</span> <span class="va">trt</span>,
                             propensity.func <span class="op">=</span> <span class="va">prop.func</span>,
                             augment.func <span class="op">=</span> <span class="va">aug.func</span>,
                             loss   <span class="op">=</span> <span class="st">"sq_loss_lasso"</span>,
                             nfolds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>    <span class="co"># option for cv.glmnet (for ITR estimation)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">subgrp.model.linear</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## family:    gaussian </span>
<span class="co">## loss:      sq_loss_lasso </span>
<span class="co">## method:    weighting </span>
<span class="co">## cutpoint:  0 </span>
<span class="co">## augmentation </span>
<span class="co">## function: augment.func </span>
<span class="co">## propensity </span>
<span class="co">## function:  propensity.func </span>
<span class="co">## </span>
<span class="co">## benefit score: f(x), </span>
<span class="co">## Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'</span>
<span class="co">## </span>
<span class="co">## Average Outcomes:</span>
<span class="co">##                Recommended 0   Recommended 1</span>
<span class="co">## Received 0  0.4082 (n = 192) -1.5707 (n = 2)</span>
<span class="co">## Received 1 -0.4157 (n = 305) -2.2139 (n = 1)</span>
<span class="co">## </span>
<span class="co">## Treatment effects conditional on subgroups:</span>
<span class="co">## Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] </span>
<span class="co">##                           0.8239 (n = 497) </span>
<span class="co">## Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] </span>
<span class="co">##                            -0.6432 (n = 3) </span>
<span class="co">## </span>
<span class="co">## NOTE: The above average outcomes are biased estimates of</span>
<span class="co">##       the expected outcomes conditional on subgroups. </span>
<span class="co">##       Use 'validate.subgroup()' to obtain unbiased estimates.</span>
<span class="co">## </span>
<span class="co">## ---------------------------------------------------</span>
<span class="co">## </span>
<span class="co">## Benefit score quantiles (f(X) for 1 vs 0): </span>
<span class="co">##       0%      25%      50%      75%     100% </span>
<span class="co">## -1.10799 -0.57674 -0.44738 -0.33098  0.07272 </span>
<span class="co">## </span>
<span class="co">## ---------------------------------------------------</span>
<span class="co">## </span>
<span class="co">## Summary of individual treatment effects: </span>
<span class="co">## E[Y|T=1, X] - E[Y|T=0, X]</span>
<span class="co">## </span>
<span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">## -2.2160 -1.1535 -0.8948 -0.9094 -0.6620  0.1454 </span>
<span class="co">## </span>
<span class="co">## ---------------------------------------------------</span>
<span class="co">## </span>
<span class="co">## 5 out of 10 interactions selected in total by the lasso (cross validation criterion).</span>
<span class="co">## </span>
<span class="co">## The first estimate is the treatment main effect, which is always selected. </span>
<span class="co">## Any other variables selected represent treatment-covariate interactions.</span>
<span class="co">## </span>
<span class="co">##           Trt1     V1      V3     V4     V5   V9</span>
<span class="co">## Estimate -0.45 -0.134 -0.1052 0.0699 0.0118 0.01</span></code></pre>
</div>
<div class="section level2">
<h2 id="using-xgboost-for-estimation-of-itrs">Using xgboost for estimation of ITRs<a class="anchor" aria-label="anchor" href="#using-xgboost-for-estimation-of-itrs"></a>
</h2>
<p>The <a href="https://jaredhuling.org/personalized/" class="external-link">personalized</a> package allows use of
<a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a> routines for direct estimation of the CATE
(conditional average treatment effect) based on gradient boosted
decision trees. This allows for highly flexible estimates of the CATE
and thus benefit scores.</p>
<p>Several arguments used by the <code>xgb.train()</code> and
<code>xgb.cv()</code> functions from <a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a> must be
specified; they are:</p>
<ul>
<li>
<code>params</code>: the list of parameters for the underlying
<code>xgboost</code> model (see help file for <code>xgb.train()</code>:
this includes <code>eta</code>, <code>max_depth</code>,
<code>nthread</code>, <code>subsample</code>,
<code>colsample_bytree</code>, etc). However, note that
<code>objective</code> and <code>eval_metric</code> will be overwritten,
as they need to be set to custom values to work within
<a href="https://jaredhuling.org/personalized/" class="external-link">personalized</a>.</li>
<li>
<code>nfold</code>: number of cross validation folds to be used by
<code>xgb.cv()</code> for tuning</li>
<li>
<code>nrounds</code>: the number of boosting iterations</li>
<li>
<code>early_stopping_rounds</code>: can optionally be set. If set to
an integer <code>k</code>, training will stop if the performance doesnâ€™t
improve for <code>k</code> rounds.</li>
</ul>
<p>We have set <code>nfolds</code> to 3 for computational reasons; it
should generally be higher, such as 10.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## xgboost tuning parameters to use:</span>
<span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>max_depth <span class="op">=</span> <span class="fl">5</span>, eta <span class="op">=</span> <span class="fl">0.01</span>, nthread <span class="op">=</span> <span class="fl">1</span>, 
              booster <span class="op">=</span> <span class="st">"gbtree"</span>, subsample <span class="op">=</span> <span class="fl">0.623</span>, colsample_bytree <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">subgrp.model.xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit.subgroup.html">fit.subgroup</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,
                        trt <span class="op">=</span> <span class="va">trt</span>,
                        propensity.func <span class="op">=</span> <span class="va">prop.func</span>,
                        augment.func <span class="op">=</span> <span class="va">aug.func</span>,
                        <span class="co">## specify xgboost via the 'loss' argument</span>
                        loss   <span class="op">=</span> <span class="st">"sq_loss_xgboost"</span>,
                        nfold <span class="op">=</span> <span class="fl">3</span>,
                        params <span class="op">=</span> <span class="va">param</span>, verbose <span class="op">=</span> <span class="fl">0</span>,
                        nrounds <span class="op">=</span> <span class="fl">5000</span>, early_stopping_rounds <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>

<span class="va">subgrp.model.xgb</span></code></pre></div>
<pre><code><span class="co">## family:    gaussian </span>
<span class="co">## loss:      sq_loss_xgboost </span>
<span class="co">## method:    weighting </span>
<span class="co">## cutpoint:  0 </span>
<span class="co">## augmentation </span>
<span class="co">## function: augment.func </span>
<span class="co">## propensity </span>
<span class="co">## function:  propensity.func </span>
<span class="co">## </span>
<span class="co">## benefit score: f(x), </span>
<span class="co">## Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'</span>
<span class="co">## </span>
<span class="co">## Average Outcomes:</span>
<span class="co">##                Recommended 0    Recommended 1</span>
<span class="co">## Received 0  1.7095 (n = 107) -1.3048 (n = 87)</span>
<span class="co">## Received 1 -1.5548 (n = 177) 1.1216 (n = 129)</span>
<span class="co">## </span>
<span class="co">## Treatment effects conditional on subgroups:</span>
<span class="co">## Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] </span>
<span class="co">##                           3.2643 (n = 284) </span>
<span class="co">## Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] </span>
<span class="co">##                           2.4264 (n = 216) </span>
<span class="co">## </span>
<span class="co">## NOTE: The above average outcomes are biased estimates of</span>
<span class="co">##       the expected outcomes conditional on subgroups. </span>
<span class="co">##       Use 'validate.subgroup()' to obtain unbiased estimates.</span>
<span class="co">## </span>
<span class="co">## ---------------------------------------------------</span>
<span class="co">## </span>
<span class="co">## Benefit score quantiles (f(X) for 1 vs 0): </span>
<span class="co">##      0%     25%     50%     75%    100% </span>
<span class="co">## -8.4688 -0.9660 -0.2056  0.3896  3.3069 </span>
<span class="co">## </span>
<span class="co">## ---------------------------------------------------</span>
<span class="co">## </span>
<span class="co">## Summary of individual treatment effects: </span>
<span class="co">## E[Y|T=1, X] - E[Y|T=0, X]</span>
<span class="co">## </span>
<span class="co">##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span>
<span class="co">## -16.9377  -1.9319  -0.4113  -0.8605   0.7792   6.6139</span></code></pre>
</div>
<div class="section level2">
<h2 id="comparing-performance-with-linear-itrs">Comparing performance with linear ITRs<a class="anchor" aria-label="anchor" href="#comparing-performance-with-linear-itrs"></a>
</h2>
<p>We first run the training/testing procedure to assess the performance
of the linear estimator (ideally, with the number of replications larger
than <code>B=100</code>). Note we do not run this part due to
computation time.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valmod.lin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.subgroup.html">validate.subgroup</a></span><span class="op">(</span><span class="va">subgrp.model.linear</span>, B <span class="op">=</span> <span class="fl">100</span>,
                            method <span class="op">=</span> <span class="st">"training_test"</span>,
                            train.fraction <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span>
<span class="va">valmod.lin</span></code></pre></div>
<p>Then we compare with the xgboost-based estimator. Although this is
based on just 5 replications, we can see that the xgboost estimator is
much better at discriminating between benefitting and non-benefitting
patients, as would be evidenced by the large treatment effect among
those predicted to benefit by the xgboost estimator and below in the
plots as the estimated conditional average treatment effect (CATE) of
the xgboost estimator tracks better with the true CATE than does the
linear estimate.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valmod.xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate.subgroup.html">validate.subgroup</a></span><span class="op">(</span><span class="va">subgrp.model.xgb</span>, B <span class="op">=</span> <span class="fl">100</span>,
                                method <span class="op">=</span> <span class="st">"training_test"</span>,
                                train.fraction <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span>
<span class="va">valmod.xgb</span></code></pre></div>
<p>We also plot the estimated CATE versus the true CATE for each
approach:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## RMSE (note: this is still on the in-sample data so</span>
<span class="co">## out-of-sample RMSE is preferred to evaluate methods)</span>

<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">delta</span> <span class="op">-</span> <span class="fu"><a href="../reference/treatment.effects.html">treatment.effects</a></span><span class="op">(</span><span class="va">subgrp.model.linear</span><span class="op">)</span><span class="op">$</span><span class="va">delta</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 3.195867</span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">delta</span> <span class="op">-</span> <span class="fu"><a href="../reference/treatment.effects.html">treatment.effects</a></span><span class="op">(</span><span class="va">subgrp.model.xgb</span><span class="op">)</span><span class="op">$</span><span class="va">delta</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 1.439912</span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">delta</span> <span class="op">~</span> <span class="fu"><a href="../reference/treatment.effects.html">treatment.effects</a></span><span class="op">(</span><span class="va">subgrp.model.linear</span><span class="op">)</span><span class="op">$</span><span class="va">delta</span>,
     ylab <span class="op">=</span> <span class="st">"True CATE"</span>, xlab <span class="op">=</span> <span class="st">"Estimated Linear CATE"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">delta</span> <span class="op">~</span> <span class="fu"><a href="../reference/treatment.effects.html">treatment.effects</a></span><span class="op">(</span><span class="va">subgrp.model.xgb</span><span class="op">)</span><span class="op">$</span><span class="va">delta</span>,
     ylab <span class="op">=</span> <span class="st">"True CATE"</span>, xlab <span class="op">=</span> <span class="st">"CATE via xgboost"</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></code></pre></div>
<p><img src="fitting_itrs_with_xgboost_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jared Huling.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
